<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI åŒæ­¥å£è­¯é€å­—ç¨¿ (é€£çºŒè¼¸å‡ºç‰ˆ)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #2c3e50; color: #ecf0f1; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { max-width: 900px; width: 100%; background: #34495e; padding: 25px; border-radius: 12px; box-shadow: 0 8px 15px rgba(0,0,0,0.3); }
        h2 { text-align: center; margin-top: 0; color: #1abc9c; }
        .controls { display: flex; gap: 15px; margin-bottom: 25px; justify-content: center; align-items: center; }
        select { padding: 8px; border-radius: 5px; border: none; outline: none; background: #ecf0f1; }
        button { padding: 10px 25px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.2s; }
        #startBtn { background: #27ae60; color: white; }
        #startBtn:hover { background: #2ecc71; }
        #stopBtn { background: #c0392b; color: white; }
        #stopBtn:disabled { background: #7f8c8d; cursor: not-allowed; }
        #clearBtn { background: #2980b9; color: white; }
        #clearBtn:hover { background: #3498db; }
        
        .display-area { display: flex; flex-direction: column; gap: 20px; }
        .track { background: #1a252f; padding: 20px; border-radius: 8px; min-height: 200px; max-height: 400px; overflow-y: auto; }
        .label { font-size: 14px; color: #bdc3c7; margin-bottom: 10px; border-bottom: 1px solid #7f8c8d; padding-bottom: 5px; }
        
        .final-text { color: #ecf0f1; line-height: 1.6; }
        .interim-text { color: #f1c40f; font-style: italic; } /* æ­£åœ¨èªªçš„è©±ç”¨é»ƒè‰²æ–œé«”é¡¯ç¤º */
        .status { text-align: center; margin-top: 15px; font-size: 14px; color: #95a5a6; }
    </style>
</head>
<body>

<div class="container">
    <h2>âš¡ AI åŒæ­¥å£è­¯é€å­—ç¨¿</h2>
    
    <div class="controls">
        <select id="sourceLang">
            <option value="zh-TW">ä¸­æ–‡ (å°ç£)</option>
            <option value="en-US">è‹±æ–‡ (ç¾åœ‹)</option>
            <option value="ja-JP">æ—¥æ–‡</option>
        </select>
        <span> â” </span>
        <select id="targetLang">
            <option value="en">è‹±æ–‡</option>
            <option value="zh-TW">ä¸­æ–‡</option>
            <option value="ja">æ—¥æ–‡</option>
        </select>
        <button id="startBtn">é–‹å§‹æ”¶éŸ³</button>
        <button id="stopBtn" disabled>åœæ­¢</button>
        <button id="clearBtn" type="button">æ¸…é™¤æ–‡å­—</button>
    </div>

    <div class="display-area">
        <div class="track" id="sourceTrack">
            <div class="label">ğŸ—£ï¸ åŸéŸ³é€å­—ç¨¿</div>
            <span id="finalOriginal" class="final-text"></span>
            <span id="interimOriginal" class="interim-text"></span>
        </div>
        
        <div class="track" id="targetTrack">
            <div class="label">ğŸŒ å³æ™‚ç¿»è­¯</div>
            <span id="finalTranslation" class="final-text"></span>
            <span id="interimTranslation" class="interim-text"></span>
        </div>
    </div>
    <div id="status" class="status">æº–å‚™å°±ç·’ï¼Œè«‹é»æ“Šã€Œé–‹å§‹æ”¶éŸ³ã€</div>
    <p class="status" style="margin-top:8px; font-size:12px; opacity:0.85;">ğŸ’¡ æº–ç¢ºåº¦æç¤ºï¼šé è¿‘éº¥å…‹é¢¨ã€æ¸›å°‘ç’°å¢ƒå™ªéŸ³ã€èªªè©±é€Ÿåº¦é©ä¸­ã€å’¬å­—æ¸…æ¥š</p>
</div>

<script>
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const clearBtn = document.getElementById('clearBtn');
    const statusText = document.getElementById('status');
    
    const finalOriginalSpan = document.getElementById('finalOriginal');
    const interimOriginalSpan = document.getElementById('interimOriginal');
    const finalTranslationSpan = document.getElementById('finalTranslation');
    const interimTranslationSpan = document.getElementById('interimTranslation');

    const sourceTrack = document.getElementById('sourceTrack');
    const targetTrack = document.getElementById('targetTrack');

    // æª¢æŸ¥ç€è¦½å™¨æ”¯æ´åº¦
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
        alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ Web Speech APIï¼Œè«‹ä½¿ç”¨æœ€æ–°ç‰ˆ Google Chromeã€‚");
    }
    const recognition = new SpeechRecognition();
    recognition.continuous = true; 
    recognition.interimResults = true; // é—œéµï¼šé–‹å•Ÿå³æ™‚(æœªå®šæ¡ˆ)è¾¨è­˜çµæœ
    recognition.maxAlternatives = 5;  // å–å¾—å¤šå€‹å€™é¸ï¼Œå¾ä¸­æŒ‘ä¿¡å¿ƒåº¦æœ€é«˜çš„ä»¥æ¸›å°‘éŒ¯å­—

    let translateTimeout; // ç”¨æ–¼æ§åˆ¶å³æ™‚ç¿»è­¯çš„é »ç‡
    let isManualStop = false; // åˆ¤æ–·æ˜¯å¦ç‚ºä½¿ç”¨è€…ä¸»å‹•æŒ‰åœæ­¢

    recognition.onstart = () => {
        statusText.innerText = "ğŸ”´ æ­£åœ¨åŒæ­¥è†è½èˆ‡ç¿»è­¯ä¸­...";
        startBtn.disabled = true;
        stopBtn.disabled = false;
    };

    // å¾å¤šå€‹å€™é¸ä¸­é¸å‡ºä¿¡å¿ƒåº¦æœ€é«˜çš„ï¼Œæé«˜è¾¨è­˜æº–ç¢ºåº¦
    function getBestTranscript(result) {
        if (!result.length) return '';
        let best = result[0];
        let bestConf = best.confidence ?? 0;
        for (let j = 1; j < result.length; j++) {
            const c = result[j].confidence ?? 0;
            if (c > bestConf) { best = result[j]; bestConf = c; }
        }
        return best.transcript;
    }

    recognition.onresult = (event) => {
        let interimTranscript = '';
        let finalTranscript = '';

        for (let i = event.resultIndex; i < event.results.length; ++i) {
            const text = getBestTranscript(event.results[i]);
            if (event.results[i].isFinal) {
                finalTranscript += text;
            } else {
                interimTranscript += text;
            }
        }
        
        // 1. å³æ™‚æ›´æ–°ã€Œæ­£åœ¨èªªã€çš„åŸæ–‡ï¼ˆé»ƒè‰²å­—ï¼‰
        interimOriginalSpan.innerText = interimTranscript;
        scrollToBottom();

        // 2. å¦‚æœæœ‰ä¸€å¥å®Œæ•´çš„è©±èªªå®Œäº†
        if (finalTranscript) {
            finalOriginalSpan.innerHTML += finalTranscript + '<br>';
            interimOriginalSpan.innerText = ''; // æ¸…ç©ºæ­£åœ¨èªªçš„å­—
            
            // ç¿»è­¯å®šæ¡ˆçš„å¥å­
            translateText(finalTranscript, true);
        }

        // 3. è™•ç†ã€Œæ­£åœ¨èªªã€çš„å³æ™‚ç¿»è­¯ (ä½¿ç”¨ debounce é¿å…æ¯è¬›ä¸€å€‹å­—å°±æˆ³ä¸€æ¬¡ API è¢«å°é–)
        if (interimTranscript) {
            clearTimeout(translateTimeout);
            translateTimeout = setTimeout(() => {
                translateText(interimTranscript, false);
            }, 600); // å»¶é² 0.6 ç§’å¾Œæ‰ç¿»è­¯æœªå®šæ¡ˆçš„åŠå¥è©±ï¼Œé”åˆ°å³æ™‚åˆä¸éåº¦æ¶ˆè€—è³‡æºçš„å¹³è¡¡
        } else {
            interimTranslationSpan.innerText = '';
        }
    };

    recognition.onerror = (event) => {
        statusText.innerText = "ç™¼ç”ŸéŒ¯èª¤: " + event.error;
    };

    recognition.onend = () => {
        if (isManualStop) {
            // ä½¿ç”¨è€…çœŸçš„æŒ‰äº†ã€Œåœæ­¢ã€ï¼Œæ‰çµæŸæ•´å€‹å¾ªç’°
            statusText.innerText = "æ”¶éŸ³å·²çµæŸã€‚";
            startBtn.disabled = false;
            stopBtn.disabled = true;
        } else {
            // éä½¿ç”¨è€…ä¸»å‹•åœæ­¢ï¼šè‡ªå‹•é‡å•Ÿæ”¶éŸ³ï¼Œç¶­æŒé•·æ™‚é–“é€£çºŒ
            statusText.innerText = "é€£ç·šç¶­æŒä¸­ï¼Œå·²è‡ªå‹•çºŒæ¥æ”¶éŸ³â€¦";
            recognition.start();
        }
    };

    startBtn.onclick = () => {
        isManualStop = false;
        recognition.lang = document.getElementById('sourceLang').value;
        recognition.start();
    };

    stopBtn.onclick = () => {
        isManualStop = true;
        recognition.stop();
    };

    clearBtn.onclick = () => {
        clearTimeout(translateTimeout);
        finalOriginalSpan.innerHTML = '';
        interimOriginalSpan.innerText = '';
        finalTranslationSpan.innerHTML = '';
        interimTranslationSpan.innerText = '';

        statusText.innerText = startBtn.disabled
            ? "å·²æ¸…é™¤æ–‡å­—ï¼ˆä»åœ¨æ”¶éŸ³ä¸­ï¼‰"
            : "å·²æ¸…é™¤æ–‡å­—ï¼Œå¯é‡æ–°é–‹å§‹æ”¶éŸ³";
        scrollToBottom();
    };

    // å‘¼å«ç¿»è­¯ API
    async function translateText(text, isFinal) {
        if (!text.trim()) return;

        const source = document.getElementById('sourceLang').value.split('-')[0];
        const target = document.getElementById('targetLang').value;
        const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${source}&tl=${target}&dt=t&q=${encodeURI(text)}`;

        try {
            const response = await fetch(url);
            const data = await response.json();
            const translatedText = data[0].map(item => item[0]).join('');
            
            if (isFinal) {
                // å¦‚æœæ˜¯å®šæ¡ˆçš„å¥å­ï¼ŒåŠ å…¥æœ€çµ‚å°è©±æ¡†ä¸¦æ¸…ç©ºæš«å­˜ç¿»è­¯
                finalTranslationSpan.innerHTML += translatedText + '<br>';
                interimTranslationSpan.innerText = '';
            } else {
                // å¦‚æœæ˜¯è¬›åˆ°ä¸€åŠçš„å¥å­ï¼Œé¡¯ç¤ºåœ¨æš«å­˜å€ï¼ˆé»ƒè‰²å­—ï¼‰
                interimTranslationSpan.innerText = translatedText;
            }
            scrollToBottom();
        } catch (error) {
            console.error("ç¿»è­¯è«‹æ±‚å¤±æ•—:", error);
        }
    }

    function scrollToBottom() {
        sourceTrack.scrollTop = sourceTrack.scrollHeight;
        targetTrack.scrollTop = targetTrack.scrollHeight;
    }
</script>

</body>
</html>